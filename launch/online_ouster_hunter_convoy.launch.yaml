## Online Lidar VTR3
session_name: vtr_online_ouster_hunter

environment:
  RMW_IMPLEMENTATION: rmw_zenoh_cpp
  ZENOH_ROUTER_CONFIG_URI: $VTRROOT/hunter/hunter2_zenoh.json5
  FOLLOWER_HOST: 192.168.2.42 # green-jetson NOTE: Hostnames do not work currently, so I am using IP until I can figure out why
  FOLLOWER_ROS_NS: mr_green

start_directory: ${VTRTEMP}
suppress_history: false

windows:
  - window_name: vtr_navigation_system
    layout: main-horizontal
    shell_command_before:
      - source ${VTRSRC}/main/install/setup.bash
      - ros2 run vtr_gui setup_server  --ros-args -r __ns:=/$ROBOT_NAME/vtr
    panes:
      - >
        ros2 launch vtr_navigation vtr.launch.py
        base_params:=ouster_hunter_default.yaml
        start_new_graph:=false
        use_sim_time:=false
        planner:="bicycle_mpc"
        model_dir:=${VTRROOT}/models

  - window_name: vtr_gui
    layout: main-horizontal
    shell_command_before:
      - source ${VTRSRC}/main/install/setup.bash
    panes:
      - ros2 run vtr_gui multi_robot_socket_client --ros-args -p robots:=["$ROBOT_NAME","$FOLLOWER_ROS_NS"]
      - ros2 run vtr_gui multi_robot_socket_server --ros-args -p robots:=["$ROBOT_NAME","$FOLLOWER_ROS_NS"]
      - ros2 run vtr_gui multi_robot_web_server --ros-args -p robots:=["$ROBOT_NAME","$FOLLOWER_ROS_NS"]
      - ros2 launch vtr_multi_robot convoy_manager.launch.py
        base_params:=ouster_hunter_default.yaml
        robots:=["$ROBOT_NAME","$FOLLOWER_ROS_NS"] # Figure out how to easily make this configurable
      # - firefox --new-window "localhost:5200" # the webpage has to wait for everything above

  - window_name: follower_vtr
    layout: main-horizontal
    shell_command_before:
      - "tmux set-hook -g session-closed 'run-shell \"ssh indro@192.168.2.42 pkill -TERM -f vtr_navigation\"'" # NOTE: There may be a better way to do this, but this works and is roughly equivalent to just exiting through an interrupt
      - ssh indro@$FOLLOWER_HOST # Figure out how to make this configurable
      - docker exec -it vtr3 bash
      - source ${VTRSRC}/main/install/setup.bash
      - ros2 run vtr_gui setup_client  --ros-args -r __ns:=/$ROBOT_NAME/vtr -p ip_address:=192.168.3.42 # NOTE: This will drop to the follower robot name 
      - export RMW_IMPLEMENTATION=rmw_zenoh_cpp
      - export ZENOH_ROUTER_CONFIG_URI=$VTRROOT/hunter/hunter2_zenoh.json5
    panes:
      - >
        ros2 launch vtr_navigation vtr.launch.py
        base_params:=ouster_hunter_default.yaml
        start_new_graph:=false
        use_sim_time:=false
        planner:="bicycle_mpc_follower"
        model_dir:=${VTRROOT}/models
        override_params:=follower_params.yaml


  - window_name: follower-ouster
    layout: main-horizontal
    shell_command_before:
      - ssh indro@$FOLLOWER_HOST # Figure out how to make this configurable
      - export RMW_IMPLEMENTATION=rmw_zenoh_cpp
      - export ZENOH_ROUTER_CONFIG_URI=$VTRROOT/hunter/hunter2_zenoh.json5
    panes:
      - docker exec -it vtr3 tmuxp load $VTRROOT/hunter/launch/ouster.launch.yaml

  - window_name: rosbag
    layout: main-horizontal
    shell_command_before:
      - ssh indro@$FOLLOWER_HOST
      - docker exec -it vtr3 bash
      - source ${VTRSRC}/main/install/setup.bash
    panes:
      - ros2 bag record /prof_plum/cmd_vel /mr_green/cmd_vel /miss_scarlet/cmd_vel /mr_green/vtr/mpc_prediction /miss_scarlet/vtr/mpc_prediction /prof_plum/vtr/mpc_prediction /mr_green/vtr/odometry /miss_scarlet/vtr/odometry /prof_plum/vtr/odometry /mr_green/vtr/leader_mpc_prediction /miss_scarlet/vtr/leader_mpc_prediction /prof_plum/vtr/leader_mpc_prediction /mr_green/vtr/mpc_ref_pose_array /miss_scarlet/vtr/mpc_ref_pose_array /prof_plum/vtr/mpc_ref_pose_array
